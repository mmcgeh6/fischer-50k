---
phase: 03-calculations-narratives
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/calculations.py
  - lib/storage.py
autonomous: true

must_haves:
  truths:
    - "Building_metrics table has 12 new columns (6 penalty + 6 narrative)"
    - "Calculator produces correct GHG emissions for both 2024-2029 and 2030-2034 periods"
    - "Calculator produces correct emissions limits from use-type sqft and 55 emissions factors"
    - "Calculator produces correct penalty values ($268 per tCO2e excess, $0 when compliant)"
    - "Calculator uses Decimal precision (not float) for all arithmetic"
    - "Calculator returns None for all fields when energy data is missing"
  artifacts:
    - path: "lib/calculations.py"
      provides: "LL97 penalty calculation engine"
      exports: ["calculate_ghg_emissions", "calculate_emissions_limit", "calculate_ll97_penalty", "CARBON_COEFFICIENTS", "EMISSIONS_FACTORS"]
    - path: "lib/storage.py"
      provides: "Schema migration for 12 new columns"
      contains: "ghg_emissions_2024_2029"
  key_links:
    - from: "lib/calculations.py"
      to: "CLAUDE.md Section 4.4"
      via: "Carbon coefficients and emissions factors"
      pattern: "Decimal.*0\\.000288962"
    - from: "lib/calculations.py"
      to: "lib/storage.py"
      via: "Column names match DB schema"
      pattern: "ghg_emissions_2024_2029|penalty_2024_2029"
---

<objective>
Create the LL97 penalty calculation engine and extend the database schema with 12 new columns for storing calculation results and narrative text.

Purpose: This is the computational core of Phase 3. The penalty calculator implements the 3-step LL97 formula (GHG emissions -> emissions limits -> penalty) using Decimal precision with all 57 use-type emissions factors for both compliance periods. The schema migration adds the columns needed to persist these results.

Output: `lib/calculations.py` with complete penalty calculator, updated `lib/storage.py` with schema migration function.
</objective>

<execution_context>
@C:\Users\minke\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\minke\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-calculations-narratives/03-RESEARCH.md
@lib/storage.py
@CLAUDE.md
@FEP_50k Implementation_Plan.md (Section 4.4 — emissions factors table, lines 282-359)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend building_metrics schema with 12 new columns</name>
  <files>lib/storage.py</files>
  <action>
Add a new function `migrate_add_calculation_columns()` to lib/storage.py that uses ALTER TABLE ADD COLUMN IF NOT EXISTS to add 12 new columns to building_metrics:

**6 penalty calculation columns (NUMERIC type):**
- ghg_emissions_2024_2029
- emissions_limit_2024_2029
- penalty_2024_2029
- ghg_emissions_2030_2034
- emissions_limit_2030_2034
- penalty_2030_2034

**6 narrative columns (TEXT type):**
- envelope_narrative
- heating_narrative
- cooling_narrative
- air_distribution_narrative
- ventilation_narrative
- dhw_narrative

Use the same connection pattern as create_building_metrics_table() — psycopg2 direct with ISOLATION_LEVEL_AUTOCOMMIT. Each column should be its own ALTER TABLE statement (PostgreSQL does not support multi-column ADD COLUMN IF NOT EXISTS in a single statement).

Also update create_building_metrics_table() to include these 12 columns in the CREATE TABLE IF NOT EXISTS statement so fresh installs get them automatically.

Do NOT modify the existing upsert_building_metrics() function — it already handles dynamic columns via its dict-based approach.
  </action>
  <verify>
Run `python -c "from lib.storage import migrate_add_calculation_columns; migrate_add_calculation_columns(); print('Migration complete')"` — should print "Migration complete" without errors.

Then verify columns exist: `python -c "from lib.storage import get_connection; conn = get_connection(); cur = conn.cursor(); cur.execute(\"SELECT column_name FROM information_schema.columns WHERE table_name = 'building_metrics' AND column_name LIKE '%narrative' OR column_name LIKE 'ghg_%' OR column_name LIKE 'emissions_%' OR column_name LIKE 'penalty_%'\"); print([r[0] for r in cur.fetchall()]); cur.close(); conn.close()"` — should list all 12 new columns.
  </verify>
  <done>building_metrics table has 12 new columns (6 NUMERIC for penalties, 6 TEXT for narratives). Migration is idempotent (safe to run multiple times).</done>
</task>

<task type="auto">
  <name>Task 2: Create LL97 penalty calculation engine</name>
  <files>lib/calculations.py</files>
  <action>
Create lib/calculations.py implementing the complete LL97 penalty calculator with these components:

**1. CARBON_COEFFICIENTS dict** — Period-specific carbon coefficients (tCO2e per unit), all as Decimal strings:
```
2024-2029: electricity=0.000288962, natural_gas=0.00005311, fuel_oil=0.00007421, steam=0.00004493
2030-2034: electricity=0.000145, natural_gas=0.00005311, fuel_oil=0.00007421, steam=0.0000432
```

**2. EMISSIONS_FACTORS dict** — 54 use-type emissions factors (tCO2e per sqft) for both periods, as Decimal strings. Map use-type keys to match the column names in storage.py USE_TYPE_SQFT_COLUMNS (snake_case, without _sqft suffix). The complete factor table from FEP_50k Implementation_Plan.md Section 4.4:

| Use Type Key | 2024-2029 | 2030-2034 |
|---|---|---|
| adult_education | 0.00758 | 0.003565528 |
| ambulatory_surgical_center | 0.01181 | 0.008980612 |
| automobile_dealership | 0.00675 | 0.002824097 |
| bank_branch | 0.00987 | 0.004036172 |
| bowling_alley | 0.00574 | 0.003103815 |
| college_university | 0.00987 | 0.002099748 |
| convenience_store_without_gas_station | 0.00675 | 0.003540032 |
| courthouse | 0.00426 | 0.001480533 |
| data_center | 0.02381 | 0.014791131 |
| distribution_center | 0.00574 | 0.0009916 |
| enclosed_mall | 0.01074 | 0.003983803 |
| financial_office | 0.00846 | 0.003697004 |
| fitness_center_health_club_gym | 0.00987 | 0.003946728 |
| food_sales | 0.01181 | 0.00520888 |
| food_service | 0.01181 | 0.007749414 |
| hospital_general_medical_surgical | 0.02381 | 0.007335204 |
| hotel | 0.00987 | 0.003850668 |
| k_12_school | 0.00675 | 0.002230588 |
| laboratory | 0.02381 | 0.026029868 |
| library | 0.00675 | 0.002218412 |
| lifestyle_center | 0.00846 | 0.00470585 |
| mailing_center_post_office | 0.00426 | 0.00198044 |
| medical_office | 0.01074 | 0.002912778 |
| movie_theater | 0.01181 | 0.005395268 |
| multifamily_housing | 0.00675 | 0.00334664 |
| museum | 0.01181 | 0.0053958 |
| non_refrigerated_warehouse | 0.00426 | 0.000883187 |
| office | 0.00758 | 0.002690852 |
| other_education | 0.00846 | 0.002934006 |
| other_entertainment_public_assembly | 0.00987 | 0.002956738 |
| other_lodging_residential | 0.00758 | 0.001901982 |
| other_mall | 0.01074 | 0.001928226 |
| other_public_services | 0.00758 | 0.003808033 |
| other_recreation | 0.00987 | 0.00447957 |
| other_services | 0.01074 | 0.001823381 |
| other_technology_science | 0.02381 | 0.010446456 |
| outpatient_rehabilitation_physical_therapy | 0.01181 | 0.006018323 |
| parking | 0.00426 | 0.000214421 |
| performing_arts | 0.00846 | 0.002472539 |
| personal_services | 0.00574 | 0.004843037 |
| pre_school_daycare | 0.00675 | 0.002362874 |
| refrigerated_warehouse | 0.00987 | 0.002852131 |
| residence_hall_dormitory | 0.00758 | 0.002464089 |
| restaurant | 0.01181 | 0.004038374 |
| retail_store | 0.00758 | 0.00210449 |
| self_storage_facility | 0.00426 | 0.00061183 |
| senior_care_community | 0.01138 | 0.004410123 |
| social_meeting_hall | 0.00987 | 0.003833108 |
| strip_mall | 0.01181 | 0.001361842 |
| supermarket_grocery_store | 0.02381 | 0.00675519 |
| (swimming_pool — NO factor, skip) | — | — |
| urgent_care_clinic_other_outpatient | 0.01181 | 0.05772375 |
| vocational_school | 0.00574 | 0.004613122 |
| wholesale_club_supercenter | 0.01138 | 0.004264962 |
| worship_facility | 0.00574 | 0.001230602 |

**Columns WITHOUT emissions factors — omit from EMISSIONS_FACTORS dict entirely (calculator skips them):**
- barracks (LL84 sub-type, no LL97 factor)
- convention_center (LL84 sub-type, no LL97 factor)
- convenience_store_with_gas_station (has factor only for "without gas station" variant)
- hotel_gym (LL84 sub-type, no LL97 factor)
- wastewater_treatment_plant (no LL97 factor)
- swimming_pool (not in Implementation Plan)
- mixed_use_property (no LL97 factor — mixed-use buildings get factors per individual use type)
- police_station (no LL97 factor)
- fire_station (no LL97 factor)
- prison_incarceration (no LL97 factor)
- residential_care_facility (no LL97 factor)
- other (generic "other" — map to "Other - Restaurant/Bar" factor: 0.02381 / 0.008505075)
- other_utility (no LL97 factor)

Wait — CORRECTION for "other": DO include it in EMISSIONS_FACTORS with values 0.02381 / 0.008505075 (the Implementation Plan's "Other - Restaurant/Bar" row). This is the generic fallback. All other "other_*" categories (other_education, other_entertainment_public_assembly, etc.) already have their own specific factors in the table above.

**Final count: 55 use-type keys in EMISSIONS_FACTORS** (54 from the table above + "other" mapped to "Other - Restaurant/Bar").

Columns with NO factor and NOT in EMISSIONS_FACTORS (13 total): barracks, convention_center, convenience_store_with_gas_station, hotel_gym, wastewater_treatment_plant, swimming_pool, mixed_use_property, police_station, fire_station, prison_incarceration, residential_care_facility, other_utility, and energy_power_station (if present).

The Implementation Plan has "Manufacturing/Industrial Plant" (0.00758 / 0.00141703) but there is no matching column in building_metrics. Skip it.

**3. calculate_ghg_emissions(electricity_kwh, natural_gas_kbtu, fuel_oil_kbtu, steam_kbtu, period) -> Decimal**
- Convert all inputs to Decimal via `Decimal(str(value))`
- Use `or 0` pattern for None inputs before conversion
- Multiply by period-specific coefficients, sum all four
- Return result quantized to 2 decimal places (ROUND_HALF_UP)

**4. calculate_emissions_limit(use_type_sqft: Dict[str, float], period: str) -> Decimal**
- Takes dict of {use_type_key: sqft_value} — keys WITHOUT _sqft suffix
- For each key present in EMISSIONS_FACTORS[period], multiply sqft (as Decimal) by factor
- Skip None/zero/missing sqft values
- Return sum quantized to 2 decimal places

**5. calculate_ll97_penalty(electricity_kwh, natural_gas_kbtu, fuel_oil_kbtu, steam_kbtu, use_type_sqft) -> Dict[str, Optional[Decimal]]**
- If no energy data at all (all four are None/zero), return dict with all 6 keys set to None
- For each period ("2024-2029", "2030-2034"):
  - Call calculate_ghg_emissions
  - Call calculate_emissions_limit
  - excess = ghg - limit; penalty = max(excess, 0) * Decimal("268")
  - Quantize penalty to 2 decimal places
- Return dict with keys: ghg_emissions_2024_2029, emissions_limit_2024_2029, penalty_2024_2029, ghg_emissions_2030_2034, emissions_limit_2030_2034, penalty_2030_2034

**6. extract_use_type_sqft(building_data: Dict) -> Dict[str, float]**
- Helper that extracts use-type sqft values from a building_data dict
- Iterates over storage.USE_TYPE_SQFT_COLUMNS, strips the _sqft suffix to get the key
- Returns dict of {key: value} for non-None, non-zero values
- This bridges the gap between DB column names (with _sqft) and calculator keys (without _sqft)

CRITICAL: All Decimal values must be initialized from strings, NOT floats. Use `Decimal("0.00758")` not `Decimal(0.00758)`.
  </action>
  <verify>
Create and run a test script. Write the file `tests/test_calculations.py`:

```python
"""Verify LL97 penalty calculation engine."""
from decimal import Decimal
from lib.calculations import (
    calculate_ll97_penalty, calculate_ghg_emissions,
    calculate_emissions_limit, extract_use_type_sqft,
    CARBON_COEFFICIENTS, EMISSIONS_FACTORS
)

# Test 1: Known values — 10M kWh electricity, 5M kBtu gas, 100k sqft office
result = calculate_ll97_penalty(
    electricity_kwh=10000000,
    natural_gas_kbtu=5000000,
    fuel_oil_kbtu=0,
    steam_kbtu=0,
    use_type_sqft={'office': 100000}
)
print('GHG 2024-2029:', result['ghg_emissions_2024_2029'])
print('Limit 2024-2029:', result['emissions_limit_2024_2029'])
print('Penalty 2024-2029:', result['penalty_2024_2029'])
# Expected: GHG = 10M*0.000288962 + 5M*0.00005311 = 2889.62 + 265.55 = 3155.17
# Limit = 100000 * 0.00758 = 758.00
# Penalty = (3155.17 - 758.00) * 268 = ~642,401.56
assert isinstance(result['penalty_2024_2029'], Decimal), "Penalty must be Decimal"
assert result['penalty_2024_2029'] > Decimal("600000"), f"Penalty too low: {result['penalty_2024_2029']}"

# Test 2: None handling
none_result = calculate_ll97_penalty(None, None, None, None, {})
assert none_result['penalty_2024_2029'] is None, "None inputs should return None penalty"
print('None handling: OK')

# Test 3: extract_use_type_sqft bridges DB column names to calculator keys
test_building = {'office_sqft': 50000, 'hotel_sqft': 30000, 'bbl': '1234567890', 'gfa': 80000}
extracted = extract_use_type_sqft(test_building)
assert 'office' in extracted and extracted['office'] == 50000, "Should strip _sqft suffix"
assert 'hotel' in extracted and extracted['hotel'] == 30000, "Should strip _sqft suffix"
assert 'bbl' not in extracted, "Should only extract use-type columns"
# Verify extracted keys match EMISSIONS_FACTORS keys
for key in extracted:
    assert key in EMISSIONS_FACTORS['2024-2029'], f"Key '{key}' not in EMISSIONS_FACTORS"
print('extract_use_type_sqft: OK')

# Test 4: Emissions factors completeness
print(f'Emissions factor count (2024-2029): {len(EMISSIONS_FACTORS["2024-2029"])}')
print(f'Emissions factor count (2030-2034): {len(EMISSIONS_FACTORS["2030-2034"])}')
assert len(EMISSIONS_FACTORS['2024-2029']) >= 54, "Should have at least 54 use-type factors"

print('\nAll tests passed!')
```

Run: `python tests/test_calculations.py` — all tests must pass.
  </verify>
  <done>lib/calculations.py exists with complete LL97 penalty calculator: 55 use-type emissions factors for both periods, Decimal precision throughout, correct formula implementation, None handling for missing data. extract_use_type_sqft correctly bridges DB column names (_sqft suffix) to calculator keys.</done>
</task>

</tasks>

<verification>
1. `python -c "from lib.storage import migrate_add_calculation_columns"` imports without error
2. `python -c "from lib.calculations import calculate_ll97_penalty, calculate_ghg_emissions, calculate_emissions_limit, extract_use_type_sqft, CARBON_COEFFICIENTS, EMISSIONS_FACTORS"` imports without error
3. All 12 new columns exist in building_metrics table
4. Penalty calculation with known inputs produces expected Decimal results
5. None/zero energy inputs return None for all penalty fields
</verification>

<success_criteria>
- lib/calculations.py exists with complete LL97 penalty calculator
- lib/storage.py has idempotent migration function for 12 new columns
- All 55 use-type emissions factors encoded as Decimal strings for both periods
- Calculator uses Decimal precision exclusively (no float arithmetic)
- Calculator handles missing data gracefully (returns None dict)
- Schema migration runs without errors on existing database
</success_criteria>

<output>
After completion, create `.planning/phases/03-calculations-narratives/03-01-SUMMARY.md`
</output>
