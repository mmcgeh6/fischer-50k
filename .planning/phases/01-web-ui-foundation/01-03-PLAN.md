---
phase: 01-web-ui-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - app.py
autonomous: false

must_haves:
  truths:
    - "User can enter a BBL number in the web interface"
    - "User can trigger data retrieval by submitting the form"
    - "User can view building identity, energy data, and compliance info in organized tabs"
    - "User can view all 6 generated system narratives"
    - "User can view GHG emissions and penalty calculations for both compliance periods"
    - "Invalid BBL input shows error message"
  artifacts:
    - path: "app.py"
      provides: "Main Streamlit application"
      min_lines: 100
      contains: "st.form"
  key_links:
    - from: "app.py"
      to: "lib/database.py"
      via: "import and function call"
      pattern: "from lib.database import.*fetch_building_by_bbl"
    - from: "app.py"
      to: "lib/api_client.py"
      via: "import and function call"
      pattern: "from lib.api_client import.*generate_all_narratives"
    - from: "app.py"
      to: "lib/validators.py"
      via: "import and function call"
      pattern: "from lib.validators import.*validate_bbl"
---

<objective>
Create the main Streamlit application that integrates all modules into a complete web interface for building data retrieval and narrative generation.

Purpose: This is the user-facing component that satisfies all Phase 1 requirements (UI-01 through UI-04). Users can enter a BBL, view building data in organized sections, see generated narratives, and view penalty calculations.

Output: Fully functional app.py that can be run with `streamlit run app.py`.
</objective>

<execution_context>
@C:\Users\minke\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\minke\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-web-ui-foundation/01-RESEARCH.md
@.planning/phases/01-web-ui-foundation/01-01-SUMMARY.md
@.planning/phases/01-web-ui-foundation/01-02-SUMMARY.md
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create main Streamlit application</name>
  <files>app.py</files>
  <action>
Create app.py following the complete example from RESEARCH.md, integrating all lib modules.

The app must satisfy these requirements:
- UI-01: BBL input form with validation
- UI-02: Display all building data fields in organized sections
- UI-03: Display 6 system narratives
- UI-04: Display GHG emissions and penalty calculations

```python
"""
Fischer 50K Building Lead Tool - Web Interface

Main Streamlit application for building data retrieval and narrative generation.
Enter a BBL to retrieve building energy data, LL97 compliance info, and
AI-generated system narratives.
"""

import streamlit as st
from lib.database import fetch_building_by_bbl, get_building_count
from lib.api_client import generate_all_narratives, NARRATIVE_CATEGORIES
from lib.validators import validate_bbl, bbl_to_dashed, get_borough_name


# Page configuration
st.set_page_config(
    page_title="Fischer 50K Building Lead Tool",
    page_icon="ðŸ¢",
    layout="wide",
    initial_sidebar_state="collapsed"
)

# Initialize session state
if 'building_data' not in st.session_state:
    st.session_state.building_data = None
if 'narratives' not in st.session_state:
    st.session_state.narratives = None
if 'current_bbl' not in st.session_state:
    st.session_state.current_bbl = None


def format_currency(value) -> str:
    """Format number as currency string."""
    if value is None or value == 0:
        return "$0"
    return f"${value:,.0f}"


def format_number(value, suffix: str = "") -> str:
    """Format number with thousands separator."""
    if value is None:
        return "N/A"
    return f"{value:,.0f}{suffix}"


def display_building_info(data: dict):
    """Display building identity and basic info."""
    st.subheader("Building Identity")

    col1, col2, col3 = st.columns(3)

    with col1:
        st.metric("BBL", data.get('bbl', 'N/A'))
        st.write(f"**Borough:** {get_borough_name(data.get('bbl', ''))}")

    with col2:
        st.metric("BIN", data.get('bin', 'N/A'))
        st.write(f"**Compliance Pathway:** {data.get('compliance_pathway', 'N/A')}")

    with col3:
        # Provide DOF lookup link
        bbl = data.get('bbl', '')
        if bbl:
            dashed = bbl_to_dashed(bbl)
            st.write(f"**DOF Lookup:** `{dashed}`")

    st.write(f"**Address:** {data.get('address', 'N/A')}")

    # Building characteristics
    st.subheader("Building Characteristics")
    char_cols = st.columns(4)
    char_cols[0].metric("Year Built", data.get('year_built', 'N/A'))
    char_cols[1].metric("Property Type", data.get('property_type', 'N/A'))
    char_cols[2].metric("Gross Floor Area", format_number(data.get('gfa'), " sqft"))
    char_cols[3].metric("Energy Star Score", data.get('energy_star_score', 'N/A'))


def display_energy_data(data: dict):
    """Display LL84 energy benchmarking data."""
    st.subheader("Energy Usage (LL84)")

    energy_cols = st.columns(4)
    energy_cols[0].metric("Electricity", format_number(data.get('electricity_kwh'), " kWh"))
    energy_cols[1].metric("Natural Gas", format_number(data.get('natural_gas_kbtu'), " kBtu"))
    energy_cols[2].metric("Fuel Oil #2", format_number(data.get('fuel_oil_kbtu'), " kBtu"))
    energy_cols[3].metric("District Steam", format_number(data.get('steam_kbtu'), " kBtu"))

    # Site EUI if available
    site_eui = data.get('site_eui')
    if site_eui:
        st.metric("Site EUI", f"{site_eui:.1f} kBtu/sqft")

    # LL87 Audit info
    st.subheader("LL87 Audit Data")
    if data.get('ll87_raw'):
        st.write(f"**Audit Period:** {data.get('ll87_period', 'Unknown')}")
        st.write(f"**Audit ID:** {data.get('ll87_audit_id', 'Unknown')}")
        with st.expander("View Raw LL87 Data", expanded=False):
            st.json(data.get('ll87_raw'))
    else:
        st.info("No LL87 audit data available for this building")


def display_penalties(data: dict):
    """Display GHG emissions and LL97 penalty calculations."""
    st.subheader("LL97 Carbon Penalties")

    st.markdown("""
    LL97 imposes penalties on buildings that exceed emissions limits.
    Penalty rate: **$268 per metric ton CO2e** above the limit.
    """)

    col1, col2 = st.columns(2)

    with col1:
        st.markdown("### 2024-2029 Period")
        ghg_1 = data.get('ghg_emissions_2024_2029')
        limit_1 = data.get('emissions_limit_2024_2029')
        penalty_1 = data.get('penalty_2024_2029')

        if ghg_1 is not None:
            st.metric("GHG Emissions", f"{ghg_1:,.1f} tCO2e")
            st.metric("Emissions Limit", f"{limit_1:,.1f} tCO2e" if limit_1 else "N/A")

            excess_1 = (ghg_1 - limit_1) if limit_1 else 0
            if excess_1 > 0:
                st.metric("Excess Emissions", f"{excess_1:,.1f} tCO2e", delta=f"+{excess_1:,.1f}", delta_color="inverse")
            else:
                st.metric("Excess Emissions", "0 tCO2e (compliant)")

            st.metric("Annual Penalty", format_currency(penalty_1))
        else:
            st.info("No penalty data available for 2024-2029")

    with col2:
        st.markdown("### 2030-2034 Period")
        ghg_2 = data.get('ghg_emissions_2030_2034')
        limit_2 = data.get('emissions_limit_2030_2034')
        penalty_2 = data.get('penalty_2030_2034')

        if ghg_2 is not None:
            st.metric("GHG Emissions", f"{ghg_2:,.1f} tCO2e")
            st.metric("Emissions Limit", f"{limit_2:,.1f} tCO2e" if limit_2 else "N/A")

            excess_2 = (ghg_2 - limit_2) if limit_2 else 0
            if excess_2 > 0:
                st.metric("Excess Emissions", f"{excess_2:,.1f} tCO2e", delta=f"+{excess_2:,.1f}", delta_color="inverse")
            else:
                st.metric("Excess Emissions", "0 tCO2e (compliant)")

            st.metric("Annual Penalty", format_currency(penalty_2))
        else:
            st.info("No penalty data available for 2030-2034")


def display_narratives(narratives: dict):
    """Display AI-generated system narratives."""
    st.subheader("System Narratives")
    st.markdown("*AI-generated descriptions based on available building data*")

    if not narratives:
        st.info("No narratives generated yet")
        return

    for category in NARRATIVE_CATEGORIES:
        narrative = narratives.get(category, "Not generated")
        with st.expander(f"{category} Narrative", expanded=False):
            if narrative.startswith("Error"):
                st.error(narrative)
            else:
                st.write(narrative)


# Main App
st.title("Fischer 50K Building Lead Tool")
st.markdown("Enter a BBL to retrieve building energy data, compliance status, and system narratives.")

# BBL Input Form
with st.form("bbl_form", clear_on_submit=False):
    col1, col2 = st.columns([3, 1])

    with col1:
        bbl_input = st.text_input(
            "BBL (10-digit numeric)",
            placeholder="1011190036",
            max_chars=10,
            help="Borough-Block-Lot identifier. Example: 1011190036 (Manhattan, Block 01119, Lot 0036)"
        )

    with col2:
        st.write("")  # Spacer for alignment
        submitted = st.form_submit_button("Retrieve Data", use_container_width=True)

# Process form submission
if submitted:
    if not bbl_input:
        st.error("Please enter a BBL number")
    elif not validate_bbl(bbl_input):
        st.error(f"Invalid BBL format: '{bbl_input}'. BBL must be 10 digits with borough 1-5.")
    else:
        # Fetch building data
        with st.spinner("Retrieving building data from LL97, LL84, LL87..."):
            try:
                building_data = fetch_building_by_bbl(bbl_input)
            except Exception as e:
                st.error(f"Database error: {str(e)}")
                building_data = None

        if not building_data:
            st.warning(f"No data found for BBL {bbl_input}. This building may not be in the LL97 Covered Buildings List.")
        else:
            st.session_state.building_data = building_data
            st.session_state.current_bbl = bbl_input
            st.success(f"Retrieved data for: {building_data.get('address', 'Unknown address')}")

            # Generate narratives
            with st.spinner("Generating system narratives with Claude (this may take 30-60 seconds)..."):
                try:
                    narratives = generate_all_narratives(building_data)
                    st.session_state.narratives = narratives
                except Exception as e:
                    st.error(f"Narrative generation error: {str(e)}")
                    st.session_state.narratives = None

# Display results if data exists in session state
if st.session_state.building_data:
    data = st.session_state.building_data

    # Create tabs for different data sections
    tab1, tab2, tab3, tab4 = st.tabs([
        "Building Info",
        "Energy Data",
        "LL97 Penalties",
        "System Narratives"
    ])

    with tab1:
        display_building_info(data)

    with tab2:
        display_energy_data(data)

    with tab3:
        display_penalties(data)

    with tab4:
        display_narratives(st.session_state.narratives)

# Footer with building count
st.divider()
try:
    total_buildings = get_building_count()
    st.caption(f"Database contains {total_buildings:,} covered buildings")
except Exception:
    st.caption("Fischer 50K Building Lead Tool")
```

Key implementation details:
- Uses st.form() to batch input (prevents rerun on keystroke)
- Session state preserves data across reruns
- Tabs organize data into logical sections (per RESEARCH.md pitfall: tab content executes immediately, but we use session state guards)
- Error handling at each stage with user-friendly messages
- Loading spinners during data retrieval and narrative generation
- Helper functions for consistent number/currency formatting
  </action>
  <verify>
    1. Run `python -c "import app; print('Syntax OK')"` - syntax check
    2. Run `streamlit run app.py` - should launch without errors
    3. Enter BBL "1011190036" to test data retrieval (requires secrets.toml)
  </verify>
  <done>
    - app.py exists with complete Streamlit application
    - BBL input form with validation
    - 4 tabs: Building Info, Energy Data, LL97 Penalties, System Narratives
    - All UI-01 through UI-04 requirements addressed
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete UI functionality</name>
  <what-built>
    Complete Streamlit web application with:
    - BBL input form with validation
    - Building data display (identity, energy, compliance)
    - LL97 penalty calculations for both periods
    - 6 AI-generated system narratives
  </what-built>
  <how-to-verify>
    **Prerequisites:**
    1. Copy `.streamlit/secrets.toml.example` to `.streamlit/secrets.toml`
    2. Fill in the real Supabase password
    3. Add your ANTHROPIC_API_KEY

    **Test Steps:**
    1. Run `pip install -r requirements.txt` (if not already done)
    2. Run `streamlit run app.py`
    3. Open http://localhost:8501 in browser
    4. Enter test BBL: `1011190036` and click "Retrieve Data"
    5. Verify:
       - Building Info tab shows BBL, BIN, address, year built, GFA
       - Energy Data tab shows electricity, gas, fuel oil, steam usage
       - LL97 Penalties tab shows GHG emissions and penalties for both periods
       - System Narratives tab shows 6 expandable narratives

    **Invalid Input Test:**
    6. Enter invalid BBL: `999` and click "Retrieve Data"
    7. Verify error message appears

    **Expected behavior:**
    - Data loads within 5-10 seconds
    - Narratives generate within 30-60 seconds (6 API calls)
    - All tabs display data in organized format
    - Invalid inputs show clear error messages
  </how-to-verify>
  <resume-signal>Type "approved" if all verification steps pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `python -c "import app"` - verifies syntax and imports
2. `streamlit run app.py` - launches application
3. Manual testing of BBL input, data display, and narrative generation
4. Verify all 4 tabs display expected content
5. Verify invalid input handling
</verification>

<success_criteria>
- UI-01: User can enter BBL and trigger retrieval (form submit)
- UI-02: User can view building data fields in Building Info and Energy Data tabs
- UI-03: User can view 6 system narratives in System Narratives tab
- UI-04: User can view GHG and penalties in LL97 Penalties tab
- Invalid BBL shows error message
- Application runs without crashes
</success_criteria>

<output>
After completion, create `.planning/phases/01-web-ui-foundation/01-03-SUMMARY.md`
</output>
